<!doctype html><html lang=en><head><title>GitOps PR Diffs: Review What You Deploy</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.663be810443bfefbb9189da05c6ad91f18f642c9bd0ec9f91dd748f00871b9e1.css integrity="sha256-ZjvoEEQ7/vu5GJ2gXGrZHxj2Qsm9Dsn5HddI8AhxueE="><link rel=icon type=image/png href=/images/site/icon.svg><meta property="og:title" content="GitOps PR Diffs: Review What You Deploy"><meta property="og:description" content="Generate Kubernetes manifest diffs at PR time, not deployment time"><meta property="og:type" content="article"><meta property="og:url" content="/posts/gitops-pr-diffs/"><meta property="article:published_time" content="2025-01-14T10:00:00+00:00"><meta property="article:modified_time" content="2025-01-14T10:00:00+00:00"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content="GitOps PR Diffs: Review What You Deploy"><meta name=twitter:description content="Generate Kubernetes manifest diffs at PR time, not deployment time"><meta name=description content="Generate Kubernetes manifest diffs at PR time, not deployment time"><script async src="https://www.googletagmanager.com/gtag/js?id=G-2E1HN9XECT"></script><script>var dnt,doNotTrack=!1;if(null&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-2E1HN9XECT")}</script><script integrity="sha256-DO4ugzEwhTW1Id1UIWn0gUJWaebCYOypeTit6LW4QB4=">let theme=localStorage.getItem("theme-scheme")||localStorage.getItem("darkmode:color-scheme")||"light";theme==="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/><img src=/images/site/icon.svg id=logo alt=Logo>
Marks Blog</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/#home>Home</a></li><li class=nav-item><a class=nav-link href=/#about>About</a></li><li class=nav-item><a class=nav-link href=/#skills>Skills</a></li><li class=nav-item><a class=nav-link href=/#experiences>Experiences</a></li><li class=nav-item><a class=nav-link href=/#projects>Projects</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>More</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=/#projects>Projects</a>
<a class=dropdown-item href=/#recent-posts>Recent Posts</a></div></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/posts>Posts</a></li><li class=nav-item><a class=nav-link href=/files/cv.pdf>CV</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/icon.svg class=d-none id=main-logo alt=Logo>
<img src=/images/site/icon.svg class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts/ data-filter=all>Posts</a></li><div class=subtree><li><a class=list-link href=/posts/gitops/ title=gitops>gitops</a></li><li><a class=list-link href=/posts/socat/ title=socat>socat</a></li><li><a class="active list-link" href=/posts/gitops-pr-diffs/ title=gitops-pr-diffs>gitops-pr-diffs</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ms-auto align-self-lg-center"><img class=rounded-circle src=/images/author/profile_hu_af83896b90796b7f.jpg alt="Author Image"><h5 class=author-name>Mark Gascoyne</h5><p class=text-muted>Tuesday, January 14, 2025 | 5 minutes</p></div><div class=title><h1>GitOps PR Diffs: Review What You Deploy</h1></div><div class=tags><ul style=padding-left:0></ul></div><div class=post-content id=post-content><p><strong>Introduction</strong>
A common pattern I see promoted is using tools that show you what will change in your cluster <em>at sync time</em> - after your code is already merged. In my view, this is already too late and goes against GitOps principles. How can Git be the source of truth if there are extra steps between merge and understanding impact?</p><p>In this post, I&rsquo;ll show you how to generate manifest diffs <em>during PR review</em>, so reviewers see exactly what will change in the cluster before they approve.</p><hr><h2 id=the-problem><strong>The Problem</strong></h2><p>Consider the typical Argo CD diff plugin workflow:</p><ol><li>Developer creates PR</li><li>Reviewer approves (without seeing cluster impact)</li><li>Code merges</li><li><strong>Now</strong> you see the diff of what will change</li><li>Sync happens</li></ol><p>The diff comes too late. The reviewer has already approved. If something looks wrong, you need another PR to fix it.</p><p><strong>GitOps should mean</strong>: what&rsquo;s in Git <em>is</em> what&rsquo;s in the cluster. Reviewers should understand the full impact before approving.</p><hr><h2 id=the-solution><strong>The Solution</strong></h2><p>Generate diffs at PR time by:</p><ol><li>Building manifests from the <strong>main branch</strong></li><li>Building manifests from the <strong>PR branch</strong></li><li>Diffing the two</li><li>Posting the result as an artifact or comment</li></ol><p>This way, reviewers see the actual Kubernetes resources that will change - deployments, services, configmaps, everything.</p><hr><h2 id=key-principle-absorb-your-helm-charts><strong>Key Principle: Absorb Your Helm Charts</strong></h2><p>Before we can diff manifests, we need actual manifests to diff. If you&rsquo;re deploying Helm charts directly via <code>helm install</code>, you don&rsquo;t have rendered manifests in Git.</p><p><strong>Instead, absorb them:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm template my-release my-chart <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --namespace my-namespace <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  &gt; components/my-service/manifests.yaml
</span></span></code></pre></div><p>Or better, use <strong>Helmfile</strong> to declaratively manage this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># helmfile.yaml - keep charts vanilla, use inline values only</span>
</span></span><span style=display:flex><span><span style=color:#f92672>releases</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>monitoring</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>chart</span>: <span style=color:#ae81ff>prometheus-community/prometheus</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>25.0.0</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Minimal inline values - external values files don&#39;t work with template</span>
</span></span></code></pre></div><p>Then render to disk:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helmfile template &gt; components/monitoring/prometheus.yaml
</span></span></code></pre></div><p><strong>Important</strong>: Keep absorbed charts as vanilla as possible. Don&rsquo;t try to configure everything via Helm values. Instead, push customisation to Kustomize overlays where changes are visible and diffable:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># groups/monitoring/kustomization.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>../../components/monitoring/prometheus.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>patches</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>patch</span>: |-<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - op: replace
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        path: /spec/replicas
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        value: 3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>target</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>prometheus-server</span>
</span></span></code></pre></div><p>This separation means:</p><ul><li><strong>Components</strong>: Vanilla absorbed charts (rarely change)</li><li><strong>Groups/Clusters</strong>: Environment-specific patches (visible in diffs)</li></ul><hr><h2 id=building-and-diffing><strong>Building and Diffing</strong></h2><p>The core CI logic is straightforward:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Build manifests from main branch</span>
</span></span><span style=display:flex><span>git checkout origin/main
</span></span><span style=display:flex><span>kustomize build clusters/prod &gt; /tmp/main-manifests.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Build manifests from PR branch</span>
</span></span><span style=display:flex><span>git checkout $PR_BRANCH
</span></span><span style=display:flex><span>kustomize build clusters/prod &gt; /tmp/pr-manifests.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Generate diff</span>
</span></span><span style=display:flex><span>diff -u /tmp/main-manifests.yaml /tmp/pr-manifests.yaml &gt; diff.txt
</span></span></code></pre></div><p>For multiple clusters or kustomization roots, iterate:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#66d9ef>for</span> root in clusters/*/; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  cluster<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>basename $root<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>  kustomize build $root &gt; /tmp/main-$cluster.yaml
</span></span><span style=display:flex><span>  <span style=color:#75715e># ... diff each</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><hr><h2 id=gitlab-ci-example><strong>GitLab CI Example</strong></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>generate-diffs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>if</span>: <span style=color:#ae81ff>$CI_MERGE_REQUEST_IID</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>changes</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>deployments/**/*</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # Fetch main branch
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    git fetch origin main
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # Build main branch manifests
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    git checkout origin/main
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    for root in clusters/*/; do
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      cluster=$(basename $root)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      kustomize build $root &gt; /tmp/main-$cluster.yaml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    done
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # Build PR branch manifests
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    git checkout $CI_COMMIT_SHA
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    for root in clusters/*/; do
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      cluster=$(basename $root)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      kustomize build $root &gt; /tmp/pr-$cluster.yaml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      diff -u /tmp/main-$cluster.yaml /tmp/pr-$cluster.yaml &gt; diffs/$cluster.diff || true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    done</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>artifacts</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>diffs/</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>when</span>: <span style=color:#ae81ff>always</span>
</span></span></code></pre></div><hr><h2 id=github-actions-example><strong>GitHub Actions Example</strong></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>Generate Manifest Diffs</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>on</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>pull_request</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;clusters/**&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;components/**&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;groups/**&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>diff</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v4</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>fetch-depth</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Setup Kustomize</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>imranismail/setup-kustomize@v2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Generate diffs</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          mkdir -p diffs
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          for root in clusters/*/; do
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            cluster=$(basename $root)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            # Build from main
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            git checkout origin/main
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            kustomize build $root &gt; /tmp/main-$cluster.yaml 2&gt;/dev/null || echo &#34;&#34; &gt; /tmp/main-$cluster.yaml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            # Build from PR
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            git checkout ${{ github.sha }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            kustomize build $root &gt; /tmp/pr-$cluster.yaml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            # Diff
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            diff -u /tmp/main-$cluster.yaml /tmp/pr-$cluster.yaml &gt; diffs/$cluster.diff || true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Upload diffs</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/upload-artifact@v4</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>manifest-diffs</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>path</span>: <span style=color:#ae81ff>diffs/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Comment on PR</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/github-script@v7</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>script</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            const fs = require(&#39;fs&#39;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            const diffs = fs.readdirSync(&#39;diffs&#39;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            let comment = &#39;## Manifest Diffs\n\n&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            for (const file of diffs) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              const content = fs.readFileSync(`diffs/${file}`, &#39;utf8&#39;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              if (content.trim()) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                comment += `&lt;details&gt;&lt;summary&gt;${file}&lt;/summary&gt;\n\n\`\`\`diff\n${content}\n\`\`\`\n&lt;/details&gt;\n\n`;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            github.rest.issues.createComment({
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              owner: context.repo.owner,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              repo: context.repo.repo,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              issue_number: context.issue.number,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              body: comment
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            });</span>
</span></span></code></pre></div><hr><h2 id=handling-multiple-layers><strong>Handling Multiple Layers</strong></h2><p>In more complex setups, you might have:</p><ul><li>Multiple clusters (prod, staging, dev)</li><li>Flux Kustomizations that reference different paths</li><li>Wave-based rollouts for multi-tenant systems</li></ul><p>The approach scales: <strong>diff each root that changed</strong>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Detect which roots changed</span>
</span></span><span style=display:flex><span>changed_roots<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>git diff --name-only origin/main | grep <span style=color:#e6db74>&#34;^clusters/&#34;</span> | cut -d<span style=color:#e6db74>&#39;/&#39;</span> -f1-2 | sort -u<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> root in $changed_roots; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Build and diff only affected roots</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>For Flux-managed clusters, you can even generate diffs per Flux Kustomization by parsing the <code>spec.path</code> from each Kustomization resource.</p><hr><h2 id=making-it-visual><strong>Making It Visual</strong></h2><p>Plain diffs work, but an HTML visualization makes review easier:</p><ul><li>Tree view of changed files/resources</li><li>Side-by-side comparison</li><li>Kubernetes metadata (kind, namespace, name)</li><li>Collapsible sections for large changes</li></ul><p>You can build this with Go templates, React, or even a simple script that wraps <code>diff2html</code>.</p><hr><h2 id=key-benefits><strong>Key Benefits</strong></h2><ol><li><strong>No Surprises</strong>: Reviewers see exactly what will change before approving</li><li><strong>Git Is Truth</strong>: The merged state <em>is</em> the deployed state - no extra steps</li><li><strong>Faster Reviews</strong>: Clear diffs mean faster, more confident approvals</li><li><strong>Catch Mistakes Early</strong>: Spot accidental changes (wrong image tag, missing resource limits) before they hit the cluster</li><li><strong>Audit Trail</strong>: Diffs become part of the PR history</li></ol><hr><h2 id=conclusion><strong>Conclusion</strong></h2><p>Showing diffs at deployment time is too late. By the time you see the impact, the code is already merged. True GitOps means understanding the full impact <em>during review</em>.</p><p>The pattern is simple:</p><ol><li><strong>Absorb</strong> Helm charts into your repo as vanilla rendered manifests</li><li><strong>Kustomize</strong> via Kustomize overlays (not Helm values)</li><li><strong>Build</strong> kustomize roots for both branches</li><li><strong>Diff</strong> and present to reviewers</li><li><strong>Review</strong> with full knowledge of cluster impact</li></ol><p>This approach has saved me countless &ldquo;oops&rdquo; moments and makes PR reviews genuinely meaningful for infrastructure changes.</p><hr><p><strong>Further Reading</strong></p><ul><li><a href=/posts/gitops/>Practical GitOps Pattern</a> - Repository structure and workflow</li><li><a href=https://kustomize.io/ target=_blank rel=noopener>Kustomize</a></li><li><a href=https://github.com/helmfile/helmfile target=_blank rel=noopener>Helmfile</a></li><li><a href=https://diff2html.xyz/ target=_blank rel=noopener>diff2html</a> - For visual diff rendering</li></ul></div><div class="row ps-3 pe-3"><div class="col-md-6 share-buttons"><strong>Share on:</strong>
<a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=%2fposts%2fgitops-pr-diffs%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=%2fposts%2fgitops-pr-diffs%2f&text=GitOps%20PR%20Diffs%3a%20Review%20What%20You%20Deploy&via=Marks%20Blog" target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=%2fposts%2fgitops-pr-diffs%2f&title=GitOps%20PR%20Diffs%3a%20Review%20What%20You%20Deploy" target=_blank><i class="fab fa-reddit"></i>
</a><a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=%2fposts%2fgitops-pr-diffs%2f&title=GitOps%20PR%20Diffs%3a%20Review%20What%20You%20Deploy" target=_blank><i class="fab fa-linkedin"></i>
</a><a class="btn icon-button bg-whatsapp" href="https://api.whatsapp.com/send?text=GitOps%20PR%20Diffs%3a%20Review%20What%20You%20Deploy %2fposts%2fgitops-pr-diffs%2f" target=_blank><i class="fab fa-whatsapp"></i>
</a><a class="btn icon-button" href="mailto:?subject=GitOps%20PR%20Diffs%3a%20Review%20What%20You%20Deploy&body=%2fposts%2fgitops-pr-diffs%2f" target=_blank><i class="fas fa-envelope-open-text"></i></a></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/mgazza/mgazza.github.io/edit/main/content/posts/gitops-pr-diffs/index.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/socat/ title="Using socat to backdoor via kubernetes" class="btn filled-button"><div><i class="fas fa-chevron-circle-left"></i> Prev</div><div class=next-prev-text>Using socat to backdoor via kubernetes</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn type=button data-bs-toggle=tooltip data-bs-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center ps-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#the-problem><strong>The Problem</strong></a></li><li><a href=#the-solution><strong>The Solution</strong></a></li><li><a href=#key-principle-absorb-your-helm-charts><strong>Key Principle: Absorb Your Helm Charts</strong></a></li><li><a href=#building-and-diffing><strong>Building and Diffing</strong></a></li><li><a href=#gitlab-ci-example><strong>GitLab CI Example</strong></a></li><li><a href=#github-actions-example><strong>GitHub Actions Example</strong></a></li><li><a href=#handling-multiple-layers><strong>Handling Multiple Layers</strong></a></li><li><a href=#making-it-visual><strong>Making It Visual</strong></a></li><li><a href=#key-benefits><strong>Key Benefits</strong></a></li><li><a href=#conclusion><strong>Conclusion</strong></a></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-start"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=/#about>About</a></li><li class=nav-item><a class=smooth-scroll href=/#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=/#experiences>Experiences</a></li><li class=nav-item><a class=smooth-scroll href=/#projects>Projects</a></li><li class=nav-item><a class=smooth-scroll href=/#education>Education</a></li><li class=nav-item><a class=smooth-scroll href=/#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:contact@markgascoyne.co.uk target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>contact@markgascoyne.co.uk</span></a></li><li><span>Location: </span><span>United Kingdom</span></li><li><a href=tel:+44%207951553010 target=_blank rel=noopener><span><i class="fas fa-phone-alt"></i></span> <span>+44 7951553010</span></a></li></ul></div></div></div><hr><div class=container><div class="row text-start"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu_b3360284c55cf72d.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">Â© 2020 Copyright.</div><div class="col-md-4 text-end"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.1af7f518a6bf704670ecc83da234ec9880ea09cbd3d2fa7ec26aa0dff25e667e.js integrity="sha256-Gvf1GKa/cEZw7Mg9ojTsmIDqCcvT0vp+wmqg3/JeZn4=" defer></script></body></html>